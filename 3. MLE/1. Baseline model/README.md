# Проект. Разработка пайплайнов подготовки данных и обучения модели

### Описание задачи

Яндекс Недвижимость — маркетплейс для аренды и покупки жилой и коммерческой недвижимости. Компания играет роль посредника между арендодателями/продавцами и потенциальными арендаторами/покупателями. 

### Проблема

Ключевая задача компании — сделать коммуникацию для обеих сторон эффективной и безопасной, ведь в процессе сделки появляется множество вопросов, которые могут перерасти в споры, и в итоге сделка не состоится. Для маркетплейса это невыгодный исход, поэтому продакт-менеджеры исследовали точки роста Яндекс Недвижимости и заметили, что часто разногласия возникают из-за цены на объект недвижимости. Всё дело в том, что у владельцев и покупателей представление о рыночной стоимости квартиры может быть разным — нужно помочь им договориться. 

Продакт-менеджеры выдвинули гипотезу, что среднемесячное количество сделок увеличится, если у сторон будет возможность провести объективную внешнюю оценку стоимости квартиры. 

### Бизнес-задача

Разработать MVP алгоритма на основе машинного обучения для оценки рыночной стоимости квартиры по её характеристикам. Это означает, что нужно создать быстрое базовое решение, использовав наиболее распространённые и простые подходы к обработке данных и обучению модели.

### Задача машинного обучения

Решить задачу регрессии по предсказанию цены на квартиру с помощью данных Яндекс Недвижимости.

### Данные

В персональной базе данных имеются таблицы `buildings` и `flats` , в которых собраны данные для предсказания цен на квартиры:
1. buildings — с данными о домах.
2. flats — с данными о квартирах в этих домах.

В таблице `buildings` есть следующие поля:
- `id` — ID дома,
- `build_year` — год постройки,
- `building_type_int` — тип здания,
- `latitude` — широта, на которой находится дом,
- `longitude` — долгота, на которой находится дом,
- `ceiling_height` — высота потолков в здании,
- `flats_count` — общее количество квартир,
- `floors_total` — общее количество этажей,
- `has_elevator` — наличие лифта.

В таблице flats хранится такая информация:
- `id` — ID квартиры,
- `building_id` — ID дома, в котором находится квартира,
- `floor` — этаж, на котором находится квартира,
- `kitchen_area` — площадь кухни,
- `living_area` — площадь гостиной,
- `rooms` — количество комнат,
- `is_apartment` — является ли квартира апартаментами,
- `studio` — является ли квартира студией,
- `total_area` — общая площадь квартиры,
- `price` — цена квартиры.

> База данных доступна только с учетными данными, предоставляемыми Яндекс Практикумом, которые не подлежат распространению в открытом доступе.

---
# Подготовка данных с помощью Airflow

`part1_airflow/notebooks/airflow.ipynb` - Основной ноутбук по первой части проекта, в котором производится изучение данных и подготовка функций для использования в DAG.

`part1_airflow/notebooks/delete_table.ipynb` - Ноутбук для удаления таблицы в базе при тестировании функций.

`part1_airflow/dags/flats_fstore.py` - DAG для загрузки объединенного датасета в таблицу `flats_fstore`.

`part1_airflow/dags/flats_fstore_clean.py` - DAG для трансформации и загрузки очищенного датасета в таблицу `flats_fstore_clean`.

Docker контейнеры Airflow запускаются из папки `part1_airflow` командой `docker compose up --build`. В Airflow после запуска добавлены подключения к базе данных `destination_db` и Telegram `telegram`. Работа DAG прошла успешно, отчет отправлен в Telegram. Контейнеры отключены командой `docker compose down`.

---
# Создание DVC-пайплайна обучения модели

`part2_dvc/notebooks/dvc.ipynb` - Основной ноутбук по DVC, в котором производится подготовка функций DAG и их тестирование.

`part2_dvc/scripts/data.py` - Функция загрузки очищенных данных и сохранение в `part2_dvc/data.initial_data.csv`.

`part2_dvc/scripts/fit.py` - Функция обучения модели, обученная модель сохраняется в `part2_dvc/models/fitted_model.pkl`.

`part2_dvc/scripts/evaluate.py` - Функция проведения кросс-валидации, результаты которой сохраняются в `part2_dvc/cv_res.json`.

DVC инициализирован и настроен посредством следующих команд:

```sh
dvc init
dvc remote add -d my_storage s3://S3_BUCKET_NAME # указать свой s3 bucket
dvc remote modify my_storage endpointurl https://storage.yandexcloud.net
dvc remote modify --local my_storage credentialpath '.env'
dvc remote modify my_storage version_aware true
```

Подготовлены файлы `dvc.yaml` и `params.yaml`. Произведен запуск DVC-пайплайна из папки `part2_dvc` командой `dvc repro dvc.yaml`, результаты работы пайплайна отправлены в S3 хранилище `dvc push`, изменения сохранены в Git `git push`.

> Данные для подключения к S3 хранилищу Яндекс Практикум не подлежат распространению в открытом доступе.