# Мониторинг

Для организации мониторинга подготовлен файл `core\monitoring.py` в папке с микросервисом, 
который использует библиотеку `prometheus_fastapi_instrumentator`. Также подготовлены две 
собственные метрики - гистограмма для значений предсказаний и медианное значение последних 
предсказаний модели (по умолчанию - 60) в виде метрики . 

Prometheus забирает метрики каждые 15 секунд с эндпоинта `/metrics`, которые впоследствии 
отображаются на дэшборде Grafana.

Дашборд для мониторинга частично подготовлен на базе 
[одного из общедоступных дашбордов FastAPI](https://grafana.com/grafana/dashboards/16110-fastapi-observability/). 
Для использования данного дашборда были исключены из JSON файла незадействованные элементы, 
а также изменены PromQL запросы для возможности отображения метрик, которые предоставлены 
посредством Prometheus FastAPI Instrumentor (исходный дашборд использует свои метрики).

Дополнительно в дашборд были включены метрики: 
1. По инфраструктуре сервиса:
    - Время запуска сервиса;
    - Общее время использования CPU;
    - Данные об используемой памяти;
2. По ML модели:
    - Медианное значение предсказания;
    - Распределение предсказаний в виде гистрограммы.

## Для мониторинга выбраны метрики нескольких слоев:

### Инфраструткурный слой:

Для быстрой оценки инфраструктуры и работы микросервиса задействованы следующие метрики:

- Метрика `process_start_time_seconds` - время запуска процесса в секундах.
Эта метрика выбрана для быстрой оценки даты и времени последнего запуска микросервиса.

- Метрика `process_cpu_seconds_total` - общее процессорное время работы микросервиса№ 
Эта метрика выбрана для оценки общего использования процессора микросервисом. 

- Метрика `process_open_fds` - количество открытых файловых дескрипторов процесса.

- Метрики `process_resident_memory_bytes` и `process_virtual_memory_bytes` - объем  
оперативной памяти и виртуальной памяти, занимаемый процессом.

Используются графики Stat и Gauge для вывода последнего значения метрик. Для значений, 
которые не меняются, либо график изменения которых не интересен - отключен вывод такого 
графика в Stat или используется Gauge.

### Метрики реального времени:
- Метрика `http_requests_total` - общее количество HTTP запросов. 

Используется график Stat для вывода последних данных - как суммарно, так и разрезе 
методов запроса. 

Также для вывода процента ошибок и количества запросов в секунду используется линейный 
график для оценки их изменения во времени.

- Метрика `http_request_duration_seconds` - гистограмма общего времени выполнения запросов.

Используется график Bar gauge для отображения последнего соотношения общего времени  
и общего количества запросов для оценки среднего времени выполнения запросов в разрезе 
эндпоинтов. Данный график выбран, так как позволяет сопоставить значения в графическом виде.

Также используется линейный график для отображения динамики изменения времени обработки 
99% запросов с применением для функций `histogram_quantile`.

- Метрика `http_requests_inprogress` - количество запросов в обработке в момент сбора метрик. 
Для включения необходимо установить значение параметра `should_instrument_requests_inprogress` 
в значение `True` (по умолчанию False) при инициализации Instrumentator'а Prometheus для 
FastAPI.

### Метрики прикладного уровня:

- Метрика `prediction_median` - собственная метрика, которая сохраняет медианное значение 
последних предсказаний (по умолчанию выбрал - 60 предсказаний, можно изменить в .env). 

> Как я понял, такое значение можно получить и из гистограммы, однако 
> заданием предусмотрено добавление двух метрик разного типа, поэтому 
> добавил такую метрику.

Используется график Stat для вывода последних предсказаний, в том числе выводится название 
значения, которое формируется из названия модели и количества последних предсказаний.

- Метрика `prediction_hist_flats_price` - гистограмма значений всех предсказаний.

Используются графики `Bar gauge` и `Heatmap`. График Bar gauge был выбран для отображения 
последних значений в виде гистограммы, от Hystogram отказался по визуальной составляющей, 
в части соответствия с видом графика Heamap. Heatmap используется для отображения изменения 
гистограммы со временем.