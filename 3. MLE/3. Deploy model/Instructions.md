# Инструкции по запуску микросервиса

Каждая инструкция выполняется из директории проекта, в котором расположен данный файл инструкций.

Если необходимо перейти в субдиректорию, об этом будет указано в перечне команд.

## 1. FastAPI микросервис в виртуальном окружение

Создание виртуального окружения и установка необходимых библиотек:

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -r ./services/requirements.txt
```

Запуск сервиса локально производится посредством запуска shell скрипта:

```bash
./services/run_locally.sh
```

### Пример curl-запроса к микросервису

Проверка работы сервиса производится посредством shell-скриптов, расположенным в папке `testing`.
В случае локального запуска сервиса, проверка производится в другом терминале.

Скрипт `check_service.sh` производит проверку работы curl-запросами к микросервису по различным эндпоинтам. Запуск скрипта производится следующей командой:

```bash
./testing/check_service.sh
```

Скрипт `check_metrics.sh` производит проверку эндпоинта отображения метрик для prometheus. Команда для запуска:

```bash
./testing/check_metrics.sh
```

Для проверки предсказания подготовлен скрипт `test_predict.sh` и JSON файл `test.json`. Скрипт тправляет POST запрос по эндпоинту `/flats_price/predict` и добавляет параметр запроса `user_id`, значение которого содержит уникальный UUID, который генерируется посредством утилиты `uuidgen`. В качестве тела POST запроса отправляется содержимое файла `test.json`. Команда для запуска скрипта:

```bash
./testing/test_predict.sh
```

Примеры curl-запросов располагаются в скриптах, сами запросы для удобства отделены остальных команд скрипта пустыми строками.

Для завершения локальной работы микросервиса необходимо перейти в терминал с запущенным сервером uvicorn и нажать комбинацию клавиш Ctrl+C.


## 2. FastAPI микросервис в Docker-контейнере

Для запуска микросервиса в Docker-контейнере используется скрипт `run_service.sh`:

```bash
./services/run_service.sh
```

Docker-контейнер запущен с флагом `--rm`, соответственно после остановки контейнер будет удален.

### Пример curl-запроса к микросервису

Проверка сервиса производится также посредством ранее использованных для этих целей скриптов:

```bash
./testing/check_service.sh
./testing/check_metrics.sh
./testing/test_predict.sh
```

Порт микросервиса в Docker-контейнере опубликован без изменений и представлен параметром `APP_PORT` в файле `services\.env`.

### Остановка микросервиса

Для остановки микросервиса необходимо запустить скрипт:

```bash
./services/stop_service.sh
```

или выполнить команду:

```bash
docker stop ml_service
```

## 3. Docker compose для микросервиса и системы моониторинга

Для запуска микросервиса и системы мониторинга подготовлен shell-скрипт:

```bash
./services/run_compose.sh
```

Либо можно перейти в директорию `services/` и запустить Docker compose самостоятельно, выполнив следующие команды:

```bash
cd services/
docker compose up --build -d
```

### Пример curl-запроса к микросервису

Проверка сервиса производится также посредством ранее использованных для этих целей скриптов:

```bash
./testing/check_service.sh
./testing/check_metrics.sh
./testing/test_predict.sh
```

Порт микросервиса в Docker-контейнере, а также порты других сервисов опубликованы по умолчанию.

### Остановка Docker compose

При необходимости остановки Docker compose предусмотрен скрипт:

```bash
./services/stop_compose.sh
```

Либо можно остановить его вручную из папки `services\`:

```bash
cd services/
docker compose stop
```

## 4. Скрипт симуляции нагрузки

Скрипт генерирует 600 запросов в течение ~150 секунд. 

Скрипт распологается в файле `testing\test_stress.py` и является python-скриптом, который отправляет запросы к микросервису в несколько потоков с небольшой задержкой после успешного получения ответа. 

Скрипт использует JSON-файл `test_stress.json` с дампом части тестовой выборки из 500 записей. Выгрузка произведена посредством Jupyter ноутбука, который располагается в директории `testing\load_test_data\`, где также располагаются sklearn-трансформеры, используемые для обработки датасета. Дополнительно включены 70 некорректных запросов к модели, а также 30 запросов к другим эндпоинтам, в том числе 3 запроса на загрузку модели.

Перед запуском скрипта необходимо установить требуемые библиотеки в виртуальное окружение python на сервере где запускается скрипт. Установка производится следующей командой: 

```bash
pip install -r ./testing/requirements.txt
```

Для запуска симуляции нагрузки можно запустить shell-скрипт:

```bash
./testing/test_stress.sh
```

Либо перейти в папку `testing` и запустить скрипт самостоятельно:

```bash
cd testing/
python test_stress.py
```

Адреса сервисов:
- микросервис: http://localhost:8081
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000